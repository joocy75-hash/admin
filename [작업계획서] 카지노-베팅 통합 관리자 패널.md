# 카지노/베팅 플랫폼 통합 관리자 패널 구현 작업계획서

> **작성일**: 2026-02-17
> **버전**: v1.0
> **분석 대상**: casino, sol, solcasino, betriver 4개 프로젝트 종합

---

## 1. 프로젝트 개요

### 1.1 목표
4개 기존 프로젝트(casino, sol, solcasino, betriver)의 관리자 기능을 종합 분석하여, **최고 수준의 완성도를 갖춘 독립형 관리자 패널**을 구현한다. 어떤 카지노/베팅 백엔드에든 API로 연결 가능한 범용 관리자 시스템을 목표로 한다.

### 1.2 핵심 요구사항
| 항목 | 설명 |
|------|------|
| 다단계 트리 구조 | Admin → 총판(Teacher) → 부본사 → 에이전트 → 유저 최대 6단계 |
| 롤링 커미션 | 베팅금액 × 비율 (레벨별 차등) |
| 죽장(Losing) 커미션 | 유저 손실금 × 비율 (에이전트별 차등) |
| 독립형 아키텍처 | 어떤 백엔드에든 API로 연결 가능 |
| 실시간 모니터링 | WebSocket 기반 실시간 대시보드 |

---

## 2. 기존 프로젝트 종합 분석

### 2.1 프로젝트별 비교 매트릭스

| 항목 | casino | sol | solcasino | betriver |
|------|--------|-----|-----------|----------|
| **기술 스택** | Laravel 12 + Next.js 16 | Pure PHP + React 19 | Fastify + gRPC + React | Laravel 11 + Vue 3 |
| **DB** | PostgreSQL 16 | MySQL 8.0 | PostgreSQL + Redis | MySQL 8.0 |
| **관리자 프레임워크** | Filament 3 | 커스텀 PHP (229파일) | React + 전용 admin-service | Blade + Inertia |
| **권한 시스템** | Spatie Permission | 14모듈 커스텀 | ADMIN/SUPER_ADMIN | is_admin boolean |
| **다단계 구조** | 3레벨 sub-affiliate | 6레벨 (code~code5) | 파트너 대시보드 | referral chain (:구분) |
| **롤링 커미션** | O (bet × rate) | O (bet × rate) | O (bet × rate) | O (type별 level별) |
| **죽장 커미션** | X | O (손실 × rate) | O (losing commission) | X |
| **에이전트 급여** | X | O (일일 정산) | X | X |
| **감사 로그** | X | X | O (전체 admin action) | X |
| **파트너 대시보드** | X | O (teacher 전용) | O (6개 API) | X |
| **게임 결과 조작** | X | O (Wingo, K3, 5D) | X | X |
| **완성도** | ★★★★☆ | ★★★☆☆ | ★★★★★ | ★★★☆☆ |

### 2.2 프로젝트별 채택 요소

```
casino     → Filament 관리자 UI 패턴, Spatie 권한 시스템, 3레벨 sub-affiliate 구조
sol        → 6단계 에이전트 계층, 에이전트 급여 시스템, 14모듈 권한 구조, 게임 결과 관리
solcasino  → 롤링+죽장 듀얼 커미션, 감사 로그, 파트너 API, 커미션 상태 머신
betriver   → 레퍼럴 체인 로직, 커미션 타입별 레벨별 분리, Transaction 모델
```

---

## 3. 선정 기술 스택

### 3.1 아키텍처 개요

```
┌─────────────────────────────────────────────────────────┐
│                    독립형 관리자 패널                       │
├─────────────────┬───────────────────────────────────────┤
│   Frontend      │   Backend (Admin API)                 │
│   Next.js 16    │   Node.js + Fastify                   │
│   React 19      │   Prisma ORM                          │
│   TailwindCSS 4 │   PostgreSQL 16                       │
│   Zustand 5     │   Redis 7 (캐시/세션)                  │
│   shadcn/ui     │   Socket.io (실시간)                   │
├─────────────────┴───────────────────────────────────────┤
│              External Casino/Betting Backend API          │
│   (casino, sol, solcasino, betriver 등 어디든 연결)        │
└─────────────────────────────────────────────────────────┘
```

### 3.2 기술 스택 상세

| 레이어 | 기술 | 선정 이유 |
|--------|------|-----------|
| **Frontend** | Next.js 16 + React 19 | casino 프로젝트에서 검증됨, SSR/SSG 지원, App Router |
| **UI 라이브러리** | shadcn/ui + TailwindCSS 4 | Filament 수준의 UI를 React로 구현, 커스터마이징 용이 |
| **상태 관리** | Zustand 5 | casino에서 사용, 경량/직관적 |
| **데이터 테이블** | TanStack Table v8 | 정렬/필터/페이지네이션/가상 스크롤 |
| **차트** | Recharts + Tremor | 대시보드 시각화 |
| **트리 시각화** | react-d3-tree | 다단계 에이전트 트리 렌더링 |
| **Backend** | Fastify 5 | solcasino에서 검증됨, Express 대비 2~3배 빠름 |
| **ORM** | Prisma 6 | TypeScript 타입 안전, 마이그레이션 관리 |
| **DB** | PostgreSQL 16 | casino/solcasino에서 사용, 재귀 쿼리(WITH RECURSIVE) 지원 |
| **캐시** | Redis 7 | 세션, 실시간 데이터, 커미션 계산 캐시 |
| **실시간** | Socket.io | 실시간 모니터링 대시보드 |
| **인증** | JWT + Refresh Token | 독립형 인증, RBAC 지원 |
| **감사 로그** | 커스텀 미들웨어 | solcasino 패턴 채택 |
| **언어** | TypeScript 5.7 | 전체 풀스택 타입 안전 |

### 3.3 프로젝트 구조

```
admin-panel/
├── apps/
│   ├── web/                          # Next.js 16 프론트엔드
│   │   ├── app/
│   │   │   ├── (auth)/               # 로그인/2FA
│   │   │   ├── (dashboard)/          # 메인 대시보드
│   │   │   ├── (agents)/             # 에이전트/파트너 관리
│   │   │   ├── (finance)/            # 재무/커미션/정산
│   │   │   ├── (users)/              # 회원 관리
│   │   │   ├── (games)/              # 게임 관리
│   │   │   ├── (content)/            # 컨텐츠/공지/팝업
│   │   │   ├── (settings)/           # 시스템 설정
│   │   │   └── (reports)/            # 리포트/통계
│   │   ├── components/
│   │   │   ├── ui/                   # shadcn/ui 컴포넌트
│   │   │   ├── data-table/           # 테이블 컴포넌트
│   │   │   ├── tree/                 # 트리 시각화
│   │   │   ├── charts/              # 차트 컴포넌트
│   │   │   └── layout/              # 레이아웃
│   │   ├── hooks/                    # 커스텀 훅
│   │   ├── stores/                   # Zustand 스토어
│   │   ├── lib/                      # 유틸리티
│   │   └── types/                    # TypeScript 타입
│   │
│   └── api/                          # Fastify 백엔드
│       ├── src/
│       │   ├── modules/
│       │   │   ├── auth/             # 인증/인가
│       │   │   ├── users/            # 회원 관리
│       │   │   ├── agents/           # 에이전트/파트너
│       │   │   ├── tree/             # 다단계 트리
│       │   │   ├── commission/       # 커미션 시스템
│       │   │   ├── settlement/       # 정산 시스템
│       │   │   ├── games/            # 게임 관리
│       │   │   ├── finance/          # 입출금/잔액
│       │   │   ├── reports/          # 리포트
│       │   │   ├── content/          # 컨텐츠
│       │   │   ├── settings/         # 설정
│       │   │   └── audit/            # 감사 로그
│       │   ├── middleware/           # 인증/권한/로깅
│       │   ├── plugins/             # Fastify 플러그인
│       │   ├── services/            # 비즈니스 로직
│       │   └── utils/               # 유틸리티
│       └── prisma/
│           ├── schema.prisma         # DB 스키마
│           └── migrations/           # 마이그레이션
│
├── packages/
│   ├── shared/                       # 공유 타입/유틸
│   │   ├── types/                    # 공통 TypeScript 타입
│   │   ├── enums/                    # 공통 Enum
│   │   └── utils/                    # 공통 유틸리티
│   └── connector/                    # 외부 백엔드 연결 어댑터
│       ├── betriver-adapter.ts
│       ├── casino-adapter.ts
│       ├── sol-adapter.ts
│       └── base-adapter.ts
│
├── docker-compose.yml
├── turbo.json                        # Turborepo 설정
├── pnpm-workspace.yaml
└── package.json
```

---

## 4. 데이터베이스 스키마

### 4.1 핵심 테이블 설계

#### 4.1.1 관리자/에이전트 계층 (Closure Table 패턴)

```sql
-- 관리자/에이전트 계정
CREATE TABLE admin_users (
    id              BIGSERIAL PRIMARY KEY,
    uuid            UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),
    username        VARCHAR(50) NOT NULL UNIQUE,
    email           VARCHAR(255) UNIQUE,
    password_hash   VARCHAR(255) NOT NULL,

    -- 에이전트 계층 정보
    role            VARCHAR(20) NOT NULL DEFAULT 'agent',
        -- 'super_admin', 'admin', 'teacher'(총판), 'sub_teacher'(부본사), 'agent', 'sub_agent'
    parent_id       BIGINT REFERENCES admin_users(id),
    depth           INT NOT NULL DEFAULT 0,           -- 트리에서의 깊이
    agent_code      VARCHAR(20) NOT NULL UNIQUE,      -- 에이전트 고유 코드

    -- 상태 및 설정
    status          VARCHAR(20) NOT NULL DEFAULT 'active',
        -- 'active', 'suspended', 'blocked', 'pending'
    max_sub_agents  INT NOT NULL DEFAULT 100,          -- 하위 에이전트 최대 수

    -- 커미션 설정 (개별 오버라이드)
    rolling_rate    DECIMAL(5,2) DEFAULT NULL,         -- NULL이면 기본값 사용
    losing_rate     DECIMAL(5,2) DEFAULT NULL,
    deposit_rate    DECIMAL(5,2) DEFAULT NULL,

    -- 지갑
    balance         DECIMAL(18,2) NOT NULL DEFAULT 0,
    pending_balance DECIMAL(18,2) NOT NULL DEFAULT 0,  -- 정산 대기 금액

    -- 보안
    two_factor_secret VARCHAR(255),
    two_factor_enabled BOOLEAN NOT NULL DEFAULT false,
    last_login_at   TIMESTAMP,
    last_login_ip   VARCHAR(45),

    -- 메타
    memo            TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Closure Table: 에이전트 계층 관계 (조상-자손 관계 모두 저장)
CREATE TABLE admin_user_tree (
    ancestor_id     BIGINT NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    descendant_id   BIGINT NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    depth           INT NOT NULL DEFAULT 0,
    PRIMARY KEY (ancestor_id, descendant_id)
);

-- 인덱스
CREATE INDEX idx_tree_ancestor ON admin_user_tree(ancestor_id);
CREATE INDEX idx_tree_descendant ON admin_user_tree(descendant_id);
CREATE INDEX idx_tree_depth ON admin_user_tree(depth);
CREATE INDEX idx_admin_parent ON admin_users(parent_id);
CREATE INDEX idx_admin_role ON admin_users(role);
CREATE INDEX idx_admin_status ON admin_users(status);
```

> **Closure Table 선택 이유**: sol의 code~code5 (인접 리스트) 방식은 레벨 수가 고정되고 쿼리가 복잡해진다. betriver의 : 구분 문자열 방식은 파싱이 필요하다. Closure Table은 **임의 깊이의 하위 트리 조회가 O(1) 조인**이며, PostgreSQL의 WITH RECURSIVE와 결합하면 최적 성능을 낸다.

#### 4.1.2 권한 시스템 (Spatie 패턴 채택)

```sql
-- 역할 정의
CREATE TABLE roles (
    id              BIGSERIAL PRIMARY KEY,
    name            VARCHAR(50) NOT NULL UNIQUE,
    guard           VARCHAR(20) NOT NULL DEFAULT 'admin',
    description     TEXT,
    is_system       BOOLEAN NOT NULL DEFAULT false,   -- 시스템 역할(삭제 불가)
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 권한 정의
CREATE TABLE permissions (
    id              BIGSERIAL PRIMARY KEY,
    name            VARCHAR(100) NOT NULL UNIQUE,     -- 'users.view', 'agents.create' 등
    module          VARCHAR(50) NOT NULL,              -- 'users', 'agents', 'finance' 등
    guard           VARCHAR(20) NOT NULL DEFAULT 'admin',
    description     TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 역할-권한 매핑
CREATE TABLE role_permissions (
    role_id         BIGINT NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    permission_id   BIGINT NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, permission_id)
);

-- 관리자-역할 매핑
CREATE TABLE admin_user_roles (
    admin_user_id   BIGINT NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    role_id         BIGINT NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    PRIMARY KEY (admin_user_id, role_id)
);

-- 기본 역할 데이터
-- super_admin: 모든 권한
-- admin: 시스템 설정 제외 모든 권한
-- teacher: 하위 에이전트 관리, 정산 조회, 파트너 대시보드
-- agent: 자기 하위 유저 조회, 정산 조회
```

#### 4.1.3 커미션 설정

```sql
-- 커미션 정책 (글로벌 설정)
CREATE TABLE commission_policies (
    id              BIGSERIAL PRIMARY KEY,
    name            VARCHAR(100) NOT NULL,
    type            VARCHAR(20) NOT NULL,
        -- 'rolling', 'losing', 'deposit', 'cpa', 'sub_level'

    -- 레벨별 비율 (JSON)
    -- {"1": 0.5, "2": 0.3, "3": 0.1, "4": 0.05, "5": 0.03, "6": 0.02}
    level_rates     JSONB NOT NULL DEFAULT '{}',

    -- 적용 조건
    game_category   VARCHAR(50),                       -- NULL이면 전체 게임 적용
    min_bet_amount  DECIMAL(18,2) DEFAULT 0,

    -- 상태
    active          BOOLEAN NOT NULL DEFAULT true,
    priority        INT NOT NULL DEFAULT 0,            -- 우선순위 (높을수록 우선)

    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 에이전트별 커미션 오버라이드
CREATE TABLE agent_commission_overrides (
    id              BIGSERIAL PRIMARY KEY,
    admin_user_id   BIGINT NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    policy_id       BIGINT NOT NULL REFERENCES commission_policies(id) ON DELETE CASCADE,

    -- 오버라이드 비율 (NULL이면 정책 기본값 사용)
    custom_rates    JSONB,                             -- {"1": 0.6, "2": 0.35}

    active          BOOLEAN NOT NULL DEFAULT true,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(admin_user_id, policy_id)
);
```

#### 4.1.4 정산 시스템

```sql
-- 커미션 발생 내역 (원장)
CREATE TABLE commission_ledger (
    id              BIGSERIAL PRIMARY KEY,
    uuid            UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),

    -- 관계
    agent_id        BIGINT NOT NULL REFERENCES admin_users(id),
    user_id         BIGINT NOT NULL,                   -- 외부 유저 ID (커넥터를 통해 참조)
    policy_id       BIGINT NOT NULL REFERENCES commission_policies(id),

    -- 커미션 정보
    type            VARCHAR(20) NOT NULL,              -- 'rolling', 'losing', 'deposit'
    level           INT NOT NULL,                      -- 몇 단계 상위 에이전트인지

    -- 금액
    source_amount   DECIMAL(18,2) NOT NULL,            -- 원본 금액 (베팅금/손실금/입금액)
    rate            DECIMAL(5,4) NOT NULL,             -- 적용 비율 (0.005 = 0.5%)
    commission_amount DECIMAL(18,2) NOT NULL,          -- 커미션 금액

    -- 상태 머신 (solcasino 패턴)
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',
        -- 'pending' → 'settled' → 'withdrawn'
        -- 'pending' → 'cancelled'

    -- 참조 정보
    reference_type  VARCHAR(50),                       -- 'bet', 'game_round', 'deposit'
    reference_id    VARCHAR(100),                      -- 외부 참조 ID

    -- 정산 정보
    settlement_id   BIGINT REFERENCES settlements(id),
    settled_at      TIMESTAMP,

    description     TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 정산 배치
CREATE TABLE settlements (
    id              BIGSERIAL PRIMARY KEY,
    uuid            UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),

    agent_id        BIGINT NOT NULL REFERENCES admin_users(id),

    -- 정산 기간
    period_start    TIMESTAMP NOT NULL,
    period_end      TIMESTAMP NOT NULL,

    -- 금액 요약
    rolling_total   DECIMAL(18,2) NOT NULL DEFAULT 0,
    losing_total    DECIMAL(18,2) NOT NULL DEFAULT 0,
    deposit_total   DECIMAL(18,2) NOT NULL DEFAULT 0,
    sub_level_total DECIMAL(18,2) NOT NULL DEFAULT 0,
    gross_total     DECIMAL(18,2) NOT NULL DEFAULT 0,  -- 총 커미션
    deductions      DECIMAL(18,2) NOT NULL DEFAULT 0,  -- 공제액
    net_total       DECIMAL(18,2) NOT NULL DEFAULT 0,  -- 순 정산액

    -- 상태
    status          VARCHAR(20) NOT NULL DEFAULT 'draft',
        -- 'draft' → 'confirmed' → 'paid'
        -- 'draft' → 'rejected'

    confirmed_by    BIGINT REFERENCES admin_users(id),
    confirmed_at    TIMESTAMP,
    paid_at         TIMESTAMP,

    memo            TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_ledger_agent ON commission_ledger(agent_id);
CREATE INDEX idx_ledger_status ON commission_ledger(status);
CREATE INDEX idx_ledger_type ON commission_ledger(type);
CREATE INDEX idx_ledger_created ON commission_ledger(created_at);
CREATE INDEX idx_settlement_agent ON settlements(agent_id);
CREATE INDEX idx_settlement_status ON settlements(status);
CREATE INDEX idx_settlement_period ON settlements(period_start, period_end);
```

#### 4.1.5 감사 로그

```sql
-- 감사 로그 (solcasino 패턴)
CREATE TABLE audit_logs (
    id              BIGSERIAL PRIMARY KEY,

    -- 행위자
    admin_user_id   BIGINT REFERENCES admin_users(id),
    ip_address      VARCHAR(45),
    user_agent      TEXT,

    -- 행위
    action          VARCHAR(50) NOT NULL,              -- 'create', 'update', 'delete', 'login', 'export'
    module          VARCHAR(50) NOT NULL,              -- 'users', 'agents', 'commission', 'settlement'
    resource_type   VARCHAR(50),                       -- 'admin_user', 'commission_policy'
    resource_id     VARCHAR(100),

    -- 변경 내용
    before_data     JSONB,                             -- 변경 전 데이터
    after_data      JSONB,                             -- 변경 후 데이터

    description     TEXT,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 파티셔닝 (월별)
-- CREATE TABLE audit_logs_2026_02 PARTITION OF audit_logs
--     FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');

CREATE INDEX idx_audit_admin ON audit_logs(admin_user_id);
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_module ON audit_logs(module);
CREATE INDEX idx_audit_created ON audit_logs(created_at);
```

#### 4.1.6 기타 핵심 테이블

```sql
-- 입출금 관리
CREATE TABLE transactions (
    id              BIGSERIAL PRIMARY KEY,
    uuid            UUID NOT NULL UNIQUE DEFAULT gen_random_uuid(),
    user_id         BIGINT NOT NULL,                   -- 외부 유저 ID
    type            VARCHAR(20) NOT NULL,              -- 'deposit', 'withdrawal', 'commission', 'adjustment'
    action          VARCHAR(10) NOT NULL,              -- 'credit', 'debit'
    amount          DECIMAL(18,2) NOT NULL,
    balance_before  DECIMAL(18,2) NOT NULL,
    balance_after   DECIMAL(18,2) NOT NULL,
    status          VARCHAR(20) NOT NULL DEFAULT 'pending',
    reference_type  VARCHAR(50),
    reference_id    VARCHAR(100),
    memo            TEXT,
    processed_by    BIGINT REFERENCES admin_users(id),
    processed_at    TIMESTAMP,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 시스템 설정
CREATE TABLE settings (
    id              BIGSERIAL PRIMARY KEY,
    group_name      VARCHAR(50) NOT NULL,
    key             VARCHAR(100) NOT NULL,
    value           JSONB NOT NULL,
    description     TEXT,
    updated_by      BIGINT REFERENCES admin_users(id),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(group_name, key)
);

-- 공지/팝업
CREATE TABLE announcements (
    id              BIGSERIAL PRIMARY KEY,
    type            VARCHAR(20) NOT NULL,              -- 'notice', 'popup', 'banner'
    title           VARCHAR(255) NOT NULL,
    content         TEXT NOT NULL,
    target          VARCHAR(20) NOT NULL DEFAULT 'all', -- 'all', 'agents', 'users'
    is_active       BOOLEAN NOT NULL DEFAULT true,
    starts_at       TIMESTAMP,
    ends_at         TIMESTAMP,
    created_by      BIGINT REFERENCES admin_users(id),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 에이전트 급여 설정 (sol 패턴)
CREATE TABLE agent_salary_configs (
    id              BIGSERIAL PRIMARY KEY,
    admin_user_id   BIGINT NOT NULL REFERENCES admin_users(id) ON DELETE CASCADE,
    salary_type     VARCHAR(20) NOT NULL,              -- 'daily', 'weekly', 'monthly'
    base_rate       DECIMAL(5,4) NOT NULL,             -- 기본 비율 (하위 총 충전 × rate)
    min_threshold   DECIMAL(18,2) NOT NULL DEFAULT 0,  -- 최소 달성 기준
    active          BOOLEAN NOT NULL DEFAULT true,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE(admin_user_id, salary_type)
);
```

---

## 5. API 엔드포인트 설계

### 5.1 인증/인가 모듈

```
POST   /api/auth/login                  # 로그인
POST   /api/auth/logout                 # 로그아웃
POST   /api/auth/refresh                # 토큰 갱신
POST   /api/auth/2fa/verify             # 2FA 인증
POST   /api/auth/2fa/setup              # 2FA 설정
GET    /api/auth/me                     # 현재 로그인 정보
PUT    /api/auth/password               # 비밀번호 변경
```

### 5.2 대시보드 모듈

```
GET    /api/dashboard/summary           # 종합 요약 (오늘/이번주/이번달)
GET    /api/dashboard/realtime          # 실시간 지표 (WebSocket 폴백)
GET    /api/dashboard/charts            # 차트 데이터 (기간별)
GET    /api/dashboard/top-agents        # 상위 에이전트 순위
GET    /api/dashboard/recent-activity   # 최근 활동
```

### 5.3 에이전트/파트너 관리 모듈

```
# 에이전트 CRUD
GET    /api/agents                      # 에이전트 목록 (필터/정렬/페이지네이션)
POST   /api/agents                      # 에이전트 생성
GET    /api/agents/:id                  # 에이전트 상세
PUT    /api/agents/:id                  # 에이전트 수정
DELETE /api/agents/:id                  # 에이전트 삭제 (소프트)
PUT    /api/agents/:id/status           # 상태 변경 (active/suspended/blocked)

# 트리 구조
GET    /api/agents/tree                 # 전체 트리 (admin 전용)
GET    /api/agents/:id/tree             # 특정 에이전트 하위 트리
GET    /api/agents/:id/ancestors        # 상위 에이전트 경로
GET    /api/agents/:id/children         # 직속 하위 에이전트
GET    /api/agents/:id/descendants      # 모든 하위 에이전트 (depth 파라미터)
POST   /api/agents/:id/move             # 에이전트 이동 (트리 재배치)

# 에이전트 통계
GET    /api/agents/:id/stats            # 에이전트 통계
GET    /api/agents/:id/users            # 에이전트 하위 유저 목록
GET    /api/agents/:id/commissions      # 에이전트 커미션 내역
GET    /api/agents/:id/settlements      # 에이전트 정산 내역
```

### 5.4 커미션 시스템 모듈

```
# 커미션 정책
GET    /api/commissions/policies              # 정책 목록
POST   /api/commissions/policies              # 정책 생성
PUT    /api/commissions/policies/:id          # 정책 수정
DELETE /api/commissions/policies/:id          # 정책 삭제

# 커미션 내역
GET    /api/commissions/ledger                # 커미션 원장 조회
GET    /api/commissions/ledger/summary        # 기간별 요약
GET    /api/commissions/ledger/:id            # 상세 내역

# 에이전트별 커미션 오버라이드
GET    /api/commissions/overrides/:agentId    # 에이전트 커미션 설정 조회
PUT    /api/commissions/overrides/:agentId    # 에이전트 커미션 설정 변경

# 커미션 계산 (외부 이벤트 수신)
POST   /api/commissions/calculate/rolling     # 롤링 커미션 계산
POST   /api/commissions/calculate/losing      # 죽장 커미션 계산
POST   /api/commissions/calculate/deposit     # 입금 커미션 계산
```

### 5.5 정산 시스템 모듈

```
# 정산
GET    /api/settlements                       # 정산 목록
POST   /api/settlements                       # 정산 생성 (배치)
GET    /api/settlements/:id                   # 정산 상세
PUT    /api/settlements/:id/confirm           # 정산 확인
PUT    /api/settlements/:id/reject            # 정산 거부
PUT    /api/settlements/:id/pay               # 정산 지급 처리

# 자동 정산
POST   /api/settlements/auto                  # 자동 정산 실행 (크론)
GET    /api/settlements/preview               # 정산 미리보기
```

### 5.6 회원 관리 모듈

```
GET    /api/users                             # 회원 목록
GET    /api/users/:id                         # 회원 상세
PUT    /api/users/:id                         # 회원 수정
PUT    /api/users/:id/status                  # 회원 상태 변경
GET    /api/users/:id/transactions            # 회원 거래 내역
GET    /api/users/:id/bets                    # 회원 베팅 내역
GET    /api/users/:id/agent                   # 회원 소속 에이전트
PUT    /api/users/:id/agent                   # 회원 에이전트 변경
POST   /api/users/:id/balance                 # 잔액 수동 조정
```

### 5.7 재무 관리 모듈

```
# 입출금
GET    /api/finance/deposits                  # 입금 목록
GET    /api/finance/withdrawals               # 출금 목록
PUT    /api/finance/deposits/:id/approve      # 입금 승인
PUT    /api/finance/withdrawals/:id/approve   # 출금 승인
PUT    /api/finance/withdrawals/:id/reject    # 출금 거부

# 리포트
GET    /api/finance/reports/daily             # 일간 리포트
GET    /api/finance/reports/weekly            # 주간 리포트
GET    /api/finance/reports/monthly           # 월간 리포트
GET    /api/finance/reports/agent/:id         # 에이전트별 리포트
GET    /api/finance/reports/export            # 리포트 내보내기 (CSV/Excel)
```

### 5.8 게임 관리 모듈

```
GET    /api/games/providers                   # 게임 프로바이더 목록
GET    /api/games                             # 게임 목록
PUT    /api/games/:id                         # 게임 설정 수정
PUT    /api/games/:id/status                  # 게임 활성/비활성
GET    /api/games/rounds                      # 게임 라운드 조회
GET    /api/games/rounds/:id                  # 게임 라운드 상세
```

### 5.9 시스템 설정 모듈

```
GET    /api/settings                          # 전체 설정
GET    /api/settings/:group                   # 그룹별 설정
PUT    /api/settings/:group                   # 설정 수정

# 역할/권한
GET    /api/roles                             # 역할 목록
POST   /api/roles                             # 역할 생성
PUT    /api/roles/:id                         # 역할 수정
DELETE /api/roles/:id                         # 역할 삭제
GET    /api/permissions                       # 전체 권한 목록

# 감사 로그
GET    /api/audit-logs                        # 감사 로그 조회
GET    /api/audit-logs/:id                    # 감사 로그 상세
GET    /api/audit-logs/export                 # 감사 로그 내보내기
```

### 5.10 파트너 대시보드 API (에이전트 전용)

```
GET    /api/partner/dashboard                 # 파트너 대시보드 요약
GET    /api/partner/tree                      # 내 하위 트리
GET    /api/partner/commissions               # 내 커미션 내역
GET    /api/partner/settlements               # 내 정산 내역
GET    /api/partner/users                     # 내 하위 유저 목록
GET    /api/partner/reports                   # 내 리포트
```

### 5.11 외부 백엔드 연결 (Connector)

```
# Webhook 수신 (외부 백엔드 → 관리자 패널)
POST   /api/connector/webhook/bet             # 베팅 이벤트 수신
POST   /api/connector/webhook/deposit         # 입금 이벤트 수신
POST   /api/connector/webhook/withdrawal      # 출금 이벤트 수신
POST   /api/connector/webhook/game-round      # 게임 라운드 결과 수신
POST   /api/connector/webhook/user-register   # 유저 가입 이벤트 수신

# 외부 백엔드 호출 (관리자 패널 → 외부 백엔드)
POST   /api/connector/sync/users              # 유저 동기화
POST   /api/connector/sync/balance            # 잔액 동기화
POST   /api/connector/action/block-user       # 유저 차단 요청
POST   /api/connector/action/adjust-balance   # 잔액 조정 요청
```

---

## 6. 프론트엔드 페이지 설계

### 6.1 페이지 구조

```
(auth)
├── /login                    # 로그인
├── /2fa                      # 2FA 인증
└── /forgot-password           # 비밀번호 찾기

(dashboard)
└── /dashboard                 # 메인 대시보드
    ├── 실시간 접속자/베팅/입출금 카운터
    ├── 기간별 매출/커미션/정산 차트
    ├── 상위 에이전트 랭킹
    ├── 최근 활동 타임라인
    └── 알림/경고 위젯

(agents) - 에이전트 관리
├── /agents                    # 에이전트 목록 (DataTable)
│   ├── 필터: 역할, 상태, 상위 에이전트, 가입일
│   ├── 정렬: 하위 유저 수, 매출, 커미션
│   └── 일괄 작업: 상태 변경, 커미션 변경
├── /agents/create             # 에이전트 생성
├── /agents/:id                # 에이전트 상세
│   ├── Tab: 기본 정보
│   ├── Tab: 하위 트리 (인터랙티브 트리 시각화)
│   ├── Tab: 하위 유저 목록
│   ├── Tab: 커미션 내역
│   ├── Tab: 정산 내역
│   └── Tab: 활동 로그
├── /agents/tree               # 전체 트리 뷰 (D3.js 기반)
│   ├── 줌/팬 인터랙션
│   ├── 노드 클릭 → 상세 정보
│   ├── 드래그 앤 드롭 → 에이전트 이동
│   └── 검색/필터
└── /agents/partner-dashboard  # 파트너 대시보드 (에이전트 로그인 시)

(finance) - 재무 관리
├── /finance/commissions       # 커미션 관리
│   ├── /policies              # 커미션 정책 설정
│   │   ├── 롤링 커미션 정책
│   │   ├── 죽장 커미션 정책
│   │   ├── 입금 커미션 정책
│   │   └── 서브레벨 커미션 정책
│   ├── /ledger                # 커미션 원장
│   └── /overrides             # 에이전트별 오버라이드
├── /finance/settlements       # 정산 관리
│   ├── 정산 목록 (상태별 필터)
│   ├── 정산 생성 (기간 선택 → 미리보기 → 확인)
│   ├── 정산 상세 (커미션 항목 상세)
│   └── 정산 내보내기 (Excel)
├── /finance/deposits          # 입금 관리
├── /finance/withdrawals       # 출금 관리
├── /finance/adjustments       # 수동 조정
└── /finance/reports           # 재무 리포트
    ├── 일간/주간/월간 리포트
    ├── 에이전트별 리포트
    └── 게임별 리포트

(users) - 회원 관리
├── /users                     # 회원 목록
├── /users/:id                 # 회원 상세
│   ├── Tab: 기본 정보
│   ├── Tab: 거래 내역
│   ├── Tab: 베팅 내역
│   ├── Tab: 소속 에이전트 정보
│   └── Tab: 활동 로그
└── /users/online              # 현재 접속 유저

(games) - 게임 관리
├── /games                     # 게임 목록
├── /games/providers           # 프로바이더 관리
├── /games/rounds              # 게임 라운드 조회
└── /games/settings            # 게임 설정

(content) - 컨텐츠 관리
├── /content/notices           # 공지사항
├── /content/popups            # 팝업 관리
├── /content/banners           # 배너 관리
└── /content/messages          # 쪽지/메시지

(reports) - 리포트
├── /reports/revenue           # 매출 리포트
├── /reports/commission        # 커미션 리포트
├── /reports/agent             # 에이전트 리포트
└── /reports/export            # 대량 내보내기

(settings) - 설정
├── /settings/general          # 일반 설정
├── /settings/roles            # 역할/권한 관리
├── /settings/commission       # 커미션 기본값 설정
├── /settings/settlement       # 정산 설정 (자동 정산 주기 등)
├── /settings/connector        # 외부 백엔드 연결 설정
├── /settings/security         # 보안 설정
└── /settings/audit-logs       # 감사 로그 조회
```

---

## 7. 핵심 비즈니스 로직 상세

### 7.1 롤링 커미션 계산 로직

```typescript
/**
 * Rolling Commission Calculator
 *
 * Source: betriver의 ReferralPay 패턴 + solcasino의 상태 머신
 *
 * 트리거: 유저가 베팅할 때마다 외부 백엔드에서 webhook 수신
 * 계산: 베팅금액 × 레벨별 비율
 * 분배: Closure Table을 통해 상위 에이전트 체인에 분배
 */
async function calculateRollingCommission(event: BetEvent) {
    const { userId, betAmount, gameCategory } = event;

    // 1. 유저의 소속 에이전트 조회
    const userAgent = await getUserAgent(userId);
    if (!userAgent) return;

    // 2. 에이전트의 상위 체인 조회 (Closure Table)
    const ancestors = await db.adminUserTree.findMany({
        where: { descendant_id: userAgent.id },
        orderBy: { depth: 'asc' },
        include: { ancestor: true }
    });

    // 3. 적용 가능한 롤링 정책 조회
    const policy = await getActivePolicy('rolling', gameCategory);
    if (!policy) return;

    // 4. 레벨별 커미션 계산 및 기록
    for (const relation of ancestors) {
        const level = relation.depth;
        if (level === 0) continue; // 자기 자신 제외

        const agent = relation.ancestor;

        // 에이전트별 오버라이드 확인
        const override = await getCommissionOverride(agent.id, policy.id);
        const rates = override?.custom_rates || policy.level_rates;
        const rate = rates[level.toString()];

        if (!rate || rate <= 0) continue;

        const commissionAmount = betAmount * rate;

        // 커미션 원장에 기록
        await db.commissionLedger.create({
            data: {
                agent_id: agent.id,
                user_id: userId,
                policy_id: policy.id,
                type: 'rolling',
                level,
                source_amount: betAmount,
                rate,
                commission_amount: commissionAmount,
                status: 'pending',
                reference_type: 'bet',
                reference_id: event.betId,
            }
        });
    }
}
```

### 7.2 죽장(Losing) 커미션 계산 로직

```typescript
/**
 * Losing (죽장) Commission Calculator
 *
 * Source: solcasino의 partner-commission.service.ts 패턴
 *
 * 트리거: 게임 라운드 종료 시 유저가 손실일 때 외부에서 webhook 수신
 * 계산: 유저 손실금 × 레벨별 비율
 * 특징: 유저가 이기면 커미션 없음, 질 때만 발생
 */
async function calculateLosingCommission(event: GameRoundEndEvent) {
    const { userId, betAmount, winAmount } = event;

    // 유저가 이기면 죽장 커미션 없음
    const lossAmount = betAmount - winAmount;
    if (lossAmount <= 0) return;

    // 1. 유저의 소속 에이전트 조회
    const userAgent = await getUserAgent(userId);
    if (!userAgent) return;

    // 2. 상위 체인 조회
    const ancestors = await db.adminUserTree.findMany({
        where: { descendant_id: userAgent.id },
        orderBy: { depth: 'asc' },
        include: { ancestor: true }
    });

    // 3. 죽장 정책 조회
    const policy = await getActivePolicy('losing', event.gameCategory);
    if (!policy) return;

    // 4. 레벨별 죽장 커미션 계산
    for (const relation of ancestors) {
        const level = relation.depth;
        if (level === 0) continue;

        const agent = relation.ancestor;
        const override = await getCommissionOverride(agent.id, policy.id);
        const rates = override?.custom_rates || policy.level_rates;
        const rate = rates[level.toString()];

        if (!rate || rate <= 0) continue;

        const commissionAmount = lossAmount * rate;

        await db.commissionLedger.create({
            data: {
                agent_id: agent.id,
                user_id: userId,
                policy_id: policy.id,
                type: 'losing',
                level,
                source_amount: lossAmount,
                rate,
                commission_amount: commissionAmount,
                status: 'pending',
                reference_type: 'game_round',
                reference_id: event.roundId,
            }
        });
    }
}
```

### 7.3 정산 프로세스

```typescript
/**
 * Settlement Process
 *
 * Source: sol의 일일 정산 패턴 + solcasino의 상태 머신
 *
 * 1. 크론 또는 수동으로 정산 기간 지정
 * 2. 해당 기간의 pending 커미션 집계
 * 3. 정산서 생성 (draft)
 * 4. 관리자 확인 (confirmed)
 * 5. 지급 처리 (paid)
 */
async function createSettlement(agentId: number, periodStart: Date, periodEnd: Date) {
    return await db.$transaction(async (tx) => {
        // 1. 해당 기간 pending 커미션 집계
        const summary = await tx.commissionLedger.groupBy({
            by: ['type'],
            where: {
                agent_id: agentId,
                status: 'pending',
                created_at: { gte: periodStart, lt: periodEnd }
            },
            _sum: { commission_amount: true }
        });

        const rollingTotal = summary.find(s => s.type === 'rolling')?._sum.commission_amount || 0;
        const losingTotal = summary.find(s => s.type === 'losing')?._sum.commission_amount || 0;
        const depositTotal = summary.find(s => s.type === 'deposit')?._sum.commission_amount || 0;
        const subLevelTotal = summary.find(s => s.type === 'sub_level')?._sum.commission_amount || 0;

        const grossTotal = rollingTotal + losingTotal + depositTotal + subLevelTotal;

        // 2. 정산서 생성
        const settlement = await tx.settlements.create({
            data: {
                agent_id: agentId,
                period_start: periodStart,
                period_end: periodEnd,
                rolling_total: rollingTotal,
                losing_total: losingTotal,
                deposit_total: depositTotal,
                sub_level_total: subLevelTotal,
                gross_total: grossTotal,
                deductions: 0,
                net_total: grossTotal,
                status: 'draft'
            }
        });

        // 3. 해당 커미션들을 정산에 연결 및 상태 변경
        await tx.commissionLedger.updateMany({
            where: {
                agent_id: agentId,
                status: 'pending',
                created_at: { gte: periodStart, lt: periodEnd }
            },
            data: {
                settlement_id: settlement.id,
                status: 'settled',
                settled_at: new Date()
            }
        });

        return settlement;
    });
}
```

### 7.4 Closure Table 관리 로직

```typescript
/**
 * Closure Table Management
 *
 * Closure Table은 에이전트 생성/이동 시 자동으로 관리된다.
 * 모든 조상-자손 관계를 명시적으로 저장하여 하위 트리 조회가 빠르다.
 */

// 에이전트 생성 시 Closure Table 업데이트
async function addAgentToTree(agentId: number, parentId: number) {
    await db.$executeRaw`
        -- 부모의 모든 조상 관계를 복사하고 depth + 1
        INSERT INTO admin_user_tree (ancestor_id, descendant_id, depth)
        SELECT ancestor_id, ${agentId}, depth + 1
        FROM admin_user_tree
        WHERE descendant_id = ${parentId}
        UNION ALL
        -- 자기 자신과의 관계 (depth = 0)
        SELECT ${agentId}, ${agentId}, 0
    `;
}

// 특정 에이전트의 전체 하위 트리 조회 (한 번의 쿼리)
async function getSubTree(agentId: number, maxDepth?: number) {
    const where: any = { ancestor_id: agentId };
    if (maxDepth) where.depth = { lte: maxDepth };

    return await db.adminUserTree.findMany({
        where,
        include: {
            descendant: {
                select: {
                    id: true, username: true, role: true,
                    status: true, balance: true, agent_code: true
                }
            }
        },
        orderBy: { depth: 'asc' }
    });
}

// 에이전트 이동 (하위 트리 포함)
async function moveAgent(agentId: number, newParentId: number) {
    await db.$transaction(async (tx) => {
        // 1. 기존 관계 삭제 (자기자신과의 관계 제외)
        await tx.$executeRaw`
            DELETE FROM admin_user_tree
            WHERE descendant_id IN (
                SELECT descendant_id FROM admin_user_tree WHERE ancestor_id = ${agentId}
            )
            AND ancestor_id IN (
                SELECT ancestor_id FROM admin_user_tree WHERE descendant_id = ${agentId}
                AND ancestor_id != descendant_id
            )
        `;

        // 2. 새 부모 기준으로 관계 재생성
        await tx.$executeRaw`
            INSERT INTO admin_user_tree (ancestor_id, descendant_id, depth)
            SELECT p.ancestor_id, c.descendant_id, p.depth + c.depth + 1
            FROM admin_user_tree p
            CROSS JOIN admin_user_tree c
            WHERE p.descendant_id = ${newParentId}
            AND c.ancestor_id = ${agentId}
        `;

        // 3. parent_id 업데이트
        await tx.adminUsers.update({
            where: { id: agentId },
            data: { parent_id: newParentId }
        });
    });
}
```

---

## 8. 구현 단계 (Phase)

### Phase 1: 프로젝트 초기 설정 (3일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 모노레포 설정 | Turborepo + pnpm workspace 초기화 | P0 |
| Next.js 16 앱 생성 | App Router, TailwindCSS 4, shadcn/ui | P0 |
| Fastify 5 앱 생성 | TypeScript, 플러그인 구조 | P0 |
| Prisma 6 설정 | PostgreSQL 연결, 스키마 정의 | P0 |
| Docker Compose | PostgreSQL 16 + Redis 7 + 앱 컨테이너 | P0 |
| 공유 패키지 설정 | types, enums, utils | P0 |
| ESLint + Prettier | 코드 스타일 통일 | P1 |

**산출물**: 빌드/실행 가능한 모노레포 프로젝트

---

### Phase 2: 인증/인가 시스템 (4일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| JWT 인증 | Access + Refresh Token, HttpOnly Cookie | P0 |
| 로그인/로그아웃 | 페이지 + API + 미들웨어 | P0 |
| 2FA (TOTP) | QR 코드 생성/검증 (speakeasy) | P0 |
| 역할/권한 모델 | roles, permissions 테이블 + CRUD | P0 |
| 권한 미들웨어 | Fastify preHandler 훅 | P0 |
| 권한 관리 UI | 역할 생성/수정, 권한 할당 | P1 |
| IP 화이트리스트 | 접속 IP 제한 (선택) | P2 |

**산출물**: 로그인 → 대시보드 진입 가능, 역할 기반 접근 제어

---

### Phase 3: 에이전트 트리 시스템 (5일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| admin_users 테이블 | 에이전트 계정 CRUD | P0 |
| Closure Table 구현 | admin_user_tree 테이블 + 트리거/함수 | P0 |
| 에이전트 생성 | 생성 시 Closure Table 자동 업데이트 | P0 |
| 에이전트 목록 | DataTable + 필터/정렬/검색/페이지네이션 | P0 |
| 에이전트 상세 | 탭 구조 (정보/트리/유저/커미션/정산/로그) | P0 |
| 트리 시각화 | react-d3-tree 기반 인터랙티브 트리 뷰 | P0 |
| 하위 트리 조회 | Closure Table 기반 O(1) 쿼리 | P0 |
| 에이전트 이동 | 드래그&드롭으로 트리 재배치 | P1 |
| 에이전트 검색 | 코드/이름으로 트리 내 검색 | P1 |

**산출물**: 6단계 에이전트 트리 생성/조회/이동 기능 완성

---

### Phase 4: 롤링 커미션 시스템 (4일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 커미션 정책 CRUD | 롤링 정책 생성/수정/삭제 | P0 |
| 레벨별 비율 설정 UI | 6단계 비율 입력 폼 | P0 |
| 커미션 계산 엔진 | Closure Table 기반 상위 체인 분배 | P0 |
| 커미션 원장 | commission_ledger 기록/조회 | P0 |
| 에이전트별 오버라이드 | 개별 에이전트 비율 커스텀 | P1 |
| 게임 카테고리별 정책 | 슬롯/라이브/스포츠별 다른 비율 | P1 |
| Webhook 수신 (베팅) | 외부 백엔드에서 베팅 이벤트 수신 | P0 |

**산출물**: 베팅 이벤트 → 6단계 롤링 커미션 자동 분배

---

### Phase 5: 죽장(Losing) 커미션 시스템 (3일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 죽장 정책 CRUD | 죽장 정책 생성/수정/삭제 | P0 |
| 죽장 계산 엔진 | 유저 손실금 기반 커미션 계산 | P0 |
| Webhook 수신 (게임라운드) | 게임 결과 이벤트 수신 | P0 |
| 죽장 원장 조회 UI | 타입별 필터링 (롤링 vs 죽장) | P0 |
| 커미션 요약 대시보드 | 롤링/죽장 합산 위젯 | P1 |

**산출물**: 게임 라운드 종료 → 유저 손실 시 죽장 커미션 자동 분배

---

### Phase 6: 정산 시스템 (4일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 정산 생성 | 기간 선택 → pending 커미션 집계 → 정산서 생성 | P0 |
| 정산 미리보기 | 정산 전 금액 확인 UI | P0 |
| 정산 확인/거부 | 관리자 승인 워크플로우 | P0 |
| 정산 지급 처리 | 에이전트 잔액에 반영 | P0 |
| 정산 목록/상세 UI | 상태별 필터, 상세 항목 확인 | P0 |
| 자동 정산 (크론) | 일일/주간/월간 자동 정산 배치 | P1 |
| 정산 내보내기 | Excel/CSV 다운로드 | P1 |
| 에이전트 급여 | sol 패턴 일일 급여 시스템 | P2 |

**산출물**: 커미션 → 정산서 → 승인 → 지급 전체 워크플로우

---

### Phase 7: 회원/재무 관리 (4일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 회원 목록/상세 | 외부 유저 데이터 연동 표시 | P0 |
| 회원-에이전트 매핑 | 회원 소속 에이전트 관리 | P0 |
| 입금 관리 | 입금 목록, 승인/거부 | P0 |
| 출금 관리 | 출금 목록, 승인/거부 | P0 |
| 잔액 수동 조정 | 관리자 수동 충전/차감 | P0 |
| 거래 내역 | 전체 트랜잭션 로그 | P0 |
| 재무 리포트 | 일간/주간/월간 집계 | P1 |

**산출물**: 회원/입출금/거래 관리 기능 완성

---

### Phase 8: 대시보드 및 리포트 (3일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 메인 대시보드 | 실시간 카운터 + 차트 + 랭킹 | P0 |
| Socket.io 실시간 | 접속자/베팅/입출금 실시간 업데이트 | P0 |
| 에이전트 리포트 | 에이전트별 성과 분석 | P1 |
| 커미션 리포트 | 롤링/죽장 비율 분석 | P1 |
| 대량 내보내기 | 리포트 Excel/PDF 생성 | P1 |

**산출물**: 실시간 대시보드 + 다차원 리포트

---

### Phase 9: 게임/컨텐츠 관리 (3일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 게임 프로바이더 관리 | 프로바이더 목록, 활성/비활성 | P0 |
| 게임 목록 관리 | 게임 설정, 카테고리 분류 | P0 |
| 게임 라운드 조회 | 게임 결과 히스토리 | P1 |
| 공지사항 CRUD | 공지 작성/수정/삭제 | P0 |
| 팝업 관리 | 팝업 생성, 기간 설정, 타겟 설정 | P1 |
| 배너 관리 | 배너 업로드/관리 | P2 |

**산출물**: 게임/컨텐츠 관리 기능 완성

---

### Phase 10: 감사 로그 및 보안 (2일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 감사 로그 미들웨어 | 모든 write 작업 자동 기록 | P0 |
| 감사 로그 조회 UI | 필터/검색/상세 보기 | P0 |
| 감사 로그 내보내기 | CSV/Excel 다운로드 | P1 |
| Rate Limiting | Fastify rate-limit 플러그인 | P0 |
| CORS 설정 | 허용 도메인 관리 | P0 |
| XSS/CSRF 방어 | 입력 검증, CSRF 토큰 | P0 |

**산출물**: 전체 관리 행위 추적 가능, 보안 강화

---

### Phase 11: 외부 백엔드 커넥터 (3일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 커넥터 인터페이스 정의 | BaseAdapter 추상 클래스 | P0 |
| Betriver 커넥터 | Laravel API 연동 어댑터 | P0 |
| Casino 커넥터 | Laravel + Filament API 연동 | P1 |
| Sol 커넥터 | PHP API 연동 어댑터 | P1 |
| Webhook 수신/검증 | HMAC 서명 검증, 재시도 로직 | P0 |
| 커넥터 설정 UI | 연결 URL/키 설정, 연결 테스트 | P0 |

**산출물**: 어떤 백엔드에든 플러그인 방식으로 연결 가능

---

### Phase 12: 파트너 대시보드 (2일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| 파트너 로그인 | 에이전트 전용 로그인 | P0 |
| 파트너 대시보드 | 내 하위 트리/커미션/정산 조회 | P0 |
| 파트너 리포트 | 내 성과 리포트 | P1 |
| 파트너 유저 관리 | 내 하위 유저 조회 | P1 |

**산출물**: 에이전트가 직접 접속하여 실적 확인 가능

---

### Phase 13: 배포 및 최적화 (2일)

| 작업 | 상세 | 우선순위 |
|------|------|----------|
| Docker 프로덕션 설정 | 멀티스테이지 빌드, Nginx 리버스 프록시 | P0 |
| 환경 변수 관리 | .env.production 분리 | P0 |
| DB 인덱스 최적화 | EXPLAIN ANALYZE 기반 쿼리 최적화 | P1 |
| Redis 캐싱 전략 | 대시보드/통계 캐싱 | P1 |
| 로깅 | Winston + 구조화 로그 | P1 |
| 헬스체크 | /health 엔드포인트, Docker 헬스체크 | P0 |

**산출물**: 프로덕션 배포 가능 상태

---

## 9. 구현 일정 요약

| Phase | 기간 | 누적 |
|-------|------|------|
| 1. 프로젝트 초기 설정 | 3일 | 3일 |
| 2. 인증/인가 시스템 | 4일 | 7일 |
| 3. 에이전트 트리 시스템 | 5일 | 12일 |
| 4. 롤링 커미션 시스템 | 4일 | 16일 |
| 5. 죽장 커미션 시스템 | 3일 | 19일 |
| 6. 정산 시스템 | 4일 | 23일 |
| 7. 회원/재무 관리 | 4일 | 27일 |
| 8. 대시보드 및 리포트 | 3일 | 30일 |
| 9. 게임/컨텐츠 관리 | 3일 | 33일 |
| 10. 감사 로그 및 보안 | 2일 | 35일 |
| 11. 외부 백엔드 커넥터 | 3일 | 38일 |
| 12. 파트너 대시보드 | 2일 | 40일 |
| 13. 배포 및 최적화 | 2일 | **42일** |

**총 예상 기간: 약 42일 (6주)**

---

## 10. 기존 프로젝트 코드 재활용 가이드

### 10.1 직접 참조할 코드

| 소스 | 파일/모듈 | 재활용 내용 |
|------|-----------|-------------|
| **betriver** | `app/Actions/ReferralPay.php` | 레퍼럴 체인 커미션 계산 로직 패턴 |
| **betriver** | `app/Enums/CommissionType.php` | 커미션 타입 Enum 구조 |
| **betriver** | `app/Models/Commission.php` | 커미션 모델 구조 (type/level/percent) |
| **casino** | `backend/app/Models/SubAffiliate*.php` | 서브 어필리에이트 3단계 모델 |
| **casino** | `backend/app/Services/CommissionService.php` | 롤링/입금 커미션 서비스 로직 |
| **casino** | `backend/app/Models/Role.php` + Permission | Spatie 권한 모델 구조 |
| **sol** | `codehub94/admin/teacher_*.php` | 총판 전용 관리 페이지 구조 |
| **sol** | `codehub94/admin/user_subtree.php` | 하위 트리 조회 로직 |
| **sol** | `codehub94/nayakaphalitansa*.php` | 롤링 정산 PHP 로직 |
| **sol** | `codehub94/niyamitakelasa*.php` | 죽장 정산 PHP 로직 |
| **solcasino** | `apps/admin-service/` | TypeScript 관리자 API 구조 |
| **solcasino** | `apps/gateway/src/services/partner-commission.service.ts` | 롤링+죽장 듀얼 커미션 구현체 |
| **solcasino** | 감사 로그 미들웨어 | 모든 admin action 로깅 패턴 |

### 10.2 참조 시 주의사항

- **sol**: 보안 취약점 8개 이상 (SQL Injection 등), 코드 패턴만 참조하고 직접 사용 금지
- **casino**: Filament 특화 코드는 React로 재구현 필요
- **betriver**: `:` 구분 문자열 방식은 Closure Table로 대체
- **solcasino**: gRPC 구조는 REST API로 단순화하되 비즈니스 로직 패턴 활용

---

## 11. 기술적 고려사항

### 11.1 성능 최적화

- **Closure Table 쿼리**: 전체 하위 트리 조회가 단일 JOIN으로 가능
- **커미션 계산 배치**: 실시간 개별 계산 + 야간 배치 검증 이중 구조
- **Redis 캐싱**: 대시보드 통계, 에이전트 트리 구조 캐싱 (TTL 5분)
- **DB 커넥션 풀링**: PgBouncer로 커넥션 관리
- **페이지네이션**: 커서 기반 페이지네이션 (대규모 데이터)

### 11.2 확장성

- **커넥터 패턴**: 새 백엔드 추가 시 어댑터만 구현
- **커미션 타입 확장**: 정책 기반이므로 새 타입 추가 용이
- **다국어**: next-intl 기반 한국어/영어/중국어 지원 준비
- **멀티 테넌시**: settings 테이블 기반 사이트별 설정 분리 가능

### 11.3 보안

- **JWT**: RS256 알고리즘, 짧은 Access Token (15분) + 긴 Refresh Token (7일)
- **2FA**: TOTP 기반, 관리자 필수
- **감사 로그**: 모든 write 작업 기록
- **IP 제한**: 관리자 접속 IP 화이트리스트
- **Rate Limiting**: API별 속도 제한
- **입력 검증**: Zod 스키마 기반 서버사이드 검증
- **암호화**: bcrypt (비밀번호), AES-256 (민감 데이터)

---

## 12. 의존성 패키지

### Frontend (apps/web)

```json
{
    "next": "^16.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "tailwindcss": "^4.0.0",
    "@tanstack/react-table": "^8.0.0",
    "@tanstack/react-query": "^5.0.0",
    "zustand": "^5.0.0",
    "recharts": "^2.14.0",
    "@tremor/react": "^3.18.0",
    "react-d3-tree": "^3.6.0",
    "socket.io-client": "^4.8.0",
    "next-intl": "^4.0.0",
    "zod": "^3.24.0",
    "lucide-react": "latest",
    "class-variance-authority": "latest",
    "clsx": "latest"
}
```

### Backend (apps/api)

```json
{
    "fastify": "^5.0.0",
    "@fastify/jwt": "^9.0.0",
    "@fastify/cookie": "^11.0.0",
    "@fastify/cors": "^11.0.0",
    "@fastify/rate-limit": "^10.0.0",
    "@fastify/websocket": "^11.0.0",
    "prisma": "^6.0.0",
    "@prisma/client": "^6.0.0",
    "socket.io": "^4.8.0",
    "ioredis": "^5.4.0",
    "speakeasy": "^2.0.0",
    "qrcode": "^1.5.0",
    "bcrypt": "^5.1.0",
    "zod": "^3.24.0",
    "winston": "^3.17.0",
    "node-cron": "^3.0.0",
    "exceljs": "^4.4.0"
}
```

### 개발 도구

```json
{
    "turbo": "^2.4.0",
    "typescript": "^5.7.0",
    "eslint": "^9.0.0",
    "prettier": "^3.4.0",
    "vitest": "^3.0.0",
    "@playwright/test": "^1.49.0"
}
```

---

## 부록 A: 커미션 계산 예시

### A.1 롤링 커미션 예시

```
에이전트 트리:
  Super Admin
  └── 총판A (rolling_rate: 0.5%)
      └── 부본사B (rolling_rate: 0.3%)
          └── 에이전트C (rolling_rate: 0.1%)
              └── 유저X (베팅: 1,000,000원)

커미션 분배:
  에이전트C (Level 1): 1,000,000 × 0.5% = 5,000원
  부본사B   (Level 2): 1,000,000 × 0.3% = 3,000원
  총판A     (Level 3): 1,000,000 × 0.1% = 1,000원

  총 롤링 커미션: 9,000원 (0.9%)
```

### A.2 죽장(Losing) 커미션 예시

```
유저X 게임 결과: 베팅 1,000,000원, 당첨 300,000원 → 손실 700,000원

커미션 분배:
  에이전트C (Level 1): 700,000 × 10% = 70,000원
  부본사B   (Level 2): 700,000 × 5%  = 35,000원
  총판A     (Level 3): 700,000 × 2%  = 14,000원

  총 죽장 커미션: 119,000원 (17%)
```

### A.3 복합 정산 예시 (일일)

```
에이전트C 일일 정산서:

[롤링 커미션]
  슬롯 게임: 하위 유저 총 베팅 50,000,000 × 0.5% = 250,000원
  라이브 게임: 하위 유저 총 베팅 30,000,000 × 0.3% = 90,000원
  스포츠 베팅: 하위 유저 총 베팅 20,000,000 × 0.2% = 40,000원
  소계: 380,000원

[죽장 커미션]
  하위 유저 총 손실금 15,000,000 × 10% = 1,500,000원
  소계: 1,500,000원

[서브레벨 커미션]
  하위 에이전트D 커미션의 20% = 50,000원
  소계: 50,000원

─────────────────────────
  총 커미션: 1,930,000원
  공제: 0원
  순 정산액: 1,930,000원
```

---

## 부록 B: 권한 모듈 목록

| 모듈 | 권한 | 설명 |
|------|------|------|
| dashboard | dashboard.view | 대시보드 조회 |
| users | users.view, users.create, users.edit, users.delete, users.balance | 회원 관리 |
| agents | agents.view, agents.create, agents.edit, agents.delete, agents.move, agents.tree | 에이전트 관리 |
| commission | commission.view, commission.policies, commission.override | 커미션 관리 |
| settlement | settlement.view, settlement.create, settlement.confirm, settlement.pay | 정산 관리 |
| finance | finance.deposits, finance.withdrawals, finance.adjust, finance.reports | 재무 관리 |
| games | games.view, games.edit, games.rounds | 게임 관리 |
| content | content.notices, content.popups, content.banners | 컨텐츠 관리 |
| reports | reports.view, reports.export | 리포트 |
| settings | settings.general, settings.roles, settings.commission, settings.connector | 시스템 설정 |
| audit | audit.view, audit.export | 감사 로그 |

**총 권한 수: 36개 (14모듈)**

---

> **이 작업계획서는 casino(Filament+Spatie), sol(6단계 에이전트+급여), solcasino(롤링+죽장 듀얼 커미션+감사로그), betriver(레퍼럴 체인+커미션 타입) 4개 프로젝트의 최적 요소를 종합하여 설계되었습니다.**
